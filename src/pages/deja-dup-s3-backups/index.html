{% from 'base.html' import heading, offsite_link, show_image %}
{{ page.set_title("Secure, Automated Backups with Amazon S3 and Deja-Dup") }}

{% extends 'blog_entry.html' %}

{% block entry_content %}

{{ heading("Background") }}

<p>
After setting myself up with a new computer a few months ago, I decided to finally configure automated backups of the data important to me. Cloud storage services can be incredibly cost-effective for this, require less hassle than Network Attached Storage, are inherently off-site and often make use of extra data redundancy. So these services seem like decent tools to use for backups.
</p>

<p>
Amazon Web Services (AWS) offers one such storage solution under the name of S3. Rates are typically around $0.01 / GB / Month for infrequently-accessed data. Google offers a competing platform with similar pricing, but I chose to use S3 as it's been around longer so more programs integrate well with it.
</p>

<p>
Duplicity, and its GUI program, Deja Dup, provide a way to use either service for incremental backups and also give the option to encrypt this data using a secret passkey that only you (and not the service storing your data) possess. Deja Dup is a linux-only program, but the command line Duplicity tool can be used on other platforms with some extra effort.
</p>

<p>
In configuring Deja Dup to backup my home directory to AWS, I was dissappointed by the lack of documentation out there. What follows is a step-by-step tutorial on how to configure AWS and Deja Dup to work together.
</p>

{{ heading("Configuring an AWS User") }}

<p>
First, {{ offsite_link("https://aws.amazon.com/", "sign up") }} for an amazon AWS account if you don't have one:
</p>
{{ show_image(page.images["0-amazon-s3-landing.png"]) }}

<p>
Follow the prompts, and you'll be deposited at the AWS landing page
(which you can always reach by clicking the AWS box icon in the top left).
</p>
{{ show_image(page.images["1-amazon-aws-homepage.png"]) }}

<p>
The first thing to do is to set up permissions / access keys. Click on the "Identity &amp; Access Management" (A.K.A "IAM") link under the "Security &amp; Identity" header. This takes you here:
</p>
{{ show_image(page.images["2-amazon-IAM-homepage.png"]) }}

<p>
From here, click "Users":
</p>
{{ show_image(page.images["3-amazon-IAM-users-page.png"]) }}

<p>
Then click "Create New Users", enter the name for your user and click "create".
</p>
{{ show_image(page.images["4-amazon-IAM-new-users.png"]) }}

<p>
Expand the "Show User Security Credentials" dropdown and note both the Access Key ID &amp; the Secret Access Key - these will be needed later.
</p>
{{ show_image(page.images["5-amazon-IAM-user-created.png"]) }}

<p>
Now return to the IAM homepage and again click on "Users". You should see your new user:
</p>
{{ show_image(page.images["6-amazon-IAM-users-page-2.png"]) }}

<p>
Click on the row that contains your user, and then click the "Permissions" tab:
</p>
{{ show_image(page.images["7-amazon-IAM-users-colin.png"]) }}

<p>
Next, click "Attach Policy" and in the filter, type "S3" and select the "AmazonS3FullAccess" policy:
</p>
{{ show_image(page.images["8-amazon-IAM-attach-policy.png"]) }}

<p>
Finally, click "Attach Policy". Now you have a user with read/write access to S3 services.
</p>


{{ heading("Configuring Deja-Dup") }}
<p>
You'll first have to install Deja Dup. This is included in most linux distributions.
However, you'll also need to install the {{ inline_code("python2-boto") }} package for Amazon S3 support. Example (Arch Linux):
</p>
{{ multiline_code("# pacman -S deja-dup python2-boto", "shell") }}

<p>
Note that if you're using a Gnome environment, the application will probably be labeled "Backups" instead of "Deja-Dup".

Launch the application:
</p>
{{ show_image(page.images["16-deja-dup-overview.png"]) }}

<p>
Go ahead and configure the folders you want to save and ignore (note: dot-prefixed folders are <i>not</i> ignored by default. You might want to think about ignoring redundant folders like {{ inline_code("~/.cache") }} to save space and bandwidth).
</p>

<p>
Then click the "Storage Location" section and configure it for Amazon S3. Use the S3 Access Key you noted previously.
</p>
{{ show_image(page.images["17-deja-dup-storage-location.png"]) }}

<p>
Return to the overview and click "Back Up Now..." to initiate the backup process. Here you'll have to enter the Secret Access Key as well.
</p>
{{ show_image(page.images["18-deja-dup-first-run-1.png"]) }}


<p>
If the permissions were correctly configured, you should be prompted to choose an optional passphrase with which to encrypt your backup. My understanding is that the data is encrypted before it reaches AWS and the passphrase is never shared with Amazon, which means only you posess the key to decrypt your backup (so don't lose your key!)
</p>
{{ show_image(page.images["19-deja-dup-first-run-2.png"]) }}

<p>
It's possible that the first backup won't show any sign of completing - the progress bar will be full, but it will still say "uploading". However, you can tell if it truly is finished by looking at the bucket in Amazon S3 and seeing that the very last difftar isn't 25 mb like all the rest:
</p>
{{ show_image(page.images["20-backup-complete.png"]) }}


{{ heading("Switching to Lower Cost Storage (Optional)") }}
<p>
Since you won't be needing a speedy CDN for your backup, you can change some settings to decrease your AWS bill.
These changes will cause accesses to your data to take 2-3 seconds instead of being near-instantaneous.

To do this, return to the Console Home (or click on the "Services" dropdown at the top of the page) and click on "S3":
</p>
{{ show_image(page.images["9-amazon-AWS-S3-link.png"]) }}

<p>
Click on "Properties" to see something like the following:
</p>
{{ show_image(page.images["11-amazon-S3-bucket-properties-2.png"]) }}

<p>
Expand the "Lifecycle" section, and then click "Add rule":
</p>
{{ show_image(page.images["12-amazon-S3-lifecycle-rule1-2.png"]) }}

<p>
Stick with the defaults for step 1 (i.e. apply to the whole bucket) and click "Configure Rule".

Check the "Transition to the Standard - Infrequent Access Storage Class" box and stick with the 30 days default (which is the minimum).
You could instead check the "Archive to the Glacier Storage Class" option, which offers even cheaper storage but at the additional cost of 3-5 hours of latency and a <i>significantly</i> higher read cost (DON'T do this unless you're sure you understand the pricing.
{{ offsite_link("https://medium.com/@karppinen/how-i-ended-up-paying-150-for-a-single-60gb-download-from-amazon-glacier-6cb77b288c3e#.pqzerjta6", "Here's") }} a cautionary tale from somebody who paid $150 to restore 60 GB of data from Amazon Glacier Storage).
</p>
{{ show_image(page.images["13-amazon-S3-lifecycle-rule2.png"]) }}

<p>
After completing the above, click "Review", give the rule some name and then click "Create and Activate Rule".
</p>
{{ show_image(page.images["14-amazon-S3-lifecycle-rule3.png"]) }}

<p>
Don't forget to click "Save"!
</p>
{{ show_image(page.images["15-amazon-S3-lifecycle-save.png"]) }}

<p>
Well that's it. The first backup may take a long time, but further backups are done incrementally. If you explore the Deja Dup tool, you'll see settings for automating further backups, etc. If you aren't happy with the default bucket name or its geographic location (US North), Juan Domenech explains how to change that over {{ offsite_link("http://blog.domenech.org/2013/01/backing-up-ubuntu-using-deja-dup-backup-and-aws-s3.html", "here") }}. I hope this tutorial was helpful!
</p>
{% endblock %}

